<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="https://growagardenstock.com/grow-a-garden-stock.png" type="image/png">
  <title>Grow Garden Warehouse</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body class="bg-green-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen">
  <!-- Dark Mode Switcher -->
  <div class="theme-switch-wrapper">
    <!-- Text and icon -->
    <span id="toggle-icon">
      <span class="toggle-text">Light Mode</span>
      <i class="fas fa-sun"></i>
    </span>
      <!-- Switcher -->
    <label class="theme-switch">
      <input type="checkbox" />
      <div class="slider round"></div>
    </label>
  </div>

  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <header class="mb-10 text-center">
      <h1 class="text-4xl font-bold text-green-800 dark:text-green-300 mb-2">
        <i class="fas fa-leaf text-green-600 dark:text-green-400 mr-2"></i> Grow Garden Warehouse
      </h1>
      <p class="text-lg text-green-600 dark:text-green-400">Inventory management dashboard</p>
    </header>

    <!-- Cards -->
<!-- Cards Section -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
  <!-- Seed Card -->
    <div id="seed-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Seeds</h3>
      <p id="seed-count" class="text-2xl font-bold text-green-600">Loading...</p>
      <p id="seed-varieties" class="text-sm text-gray-500">Items: ...</p>
      <div class="h-2 bg-gray-200 rounded-full mt-2">
        <div id="seed-progress" class="h-2 bg-green-500 rounded-full" style="width: 0%"></div>
      </div>
    </div>

  <!-- Gear Card -->
    <div id="gear-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Gear</h3>
      <p id="gear-count" class="text-2xl font-bold text-blue-600">Loading...</p>
      <p id="gear-categories" class="text-sm text-gray-500">Items: ...</p>
      <div class="h-2 bg-gray-200 rounded-full mt-2">
        <div id="gear-progress" class="h-2 bg-blue-500 rounded-full" style="width: 0%"></div>
      </div>
    </div>

  <!-- Egg Card -->
    <div id="egg-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Eggs</h3>
      <p id="egg-count" class="text-2xl font-bold text-yellow-600">Loading...</p>
      <p id="egg-types" class="text-sm text-gray-500">Items: ...</p>
      <div class="h-2 bg-gray-200 rounded-full mt-2">
        <div id="egg-progress" class="h-2 bg-yellow-500 rounded-full" style="width: 0%"></div>
      </div>
    </div>
    <div id="active-weather-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full col-span-full">
      <div class="flex items-center space-x-4">
      <img id="weather-img" src="" alt="Weather Icon" class="w-12 h-12">
      <div>
        <h3 id="weather-name" class="text-xl font-bold text-green-700 dark:text-green-300">Normal</h3>
        <p id="weather-timer" class="text-sm text-gray-500">No active event</p>
      </div>
    </div>
  </div>
  <!-- Event Card -->
    <div id="event-card" class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-2">Cosmetics</h3>
      <p id="event-count" class="text-2xl font-bold text-purple-600">Loading...</p>
      <p id="event-upcoming" class="text-sm text-gray-500">Items: ...</p>
      <div class="h-2 bg-gray-200 rounded-full mt-2">
        <div id="event-progress" class="h-2 bg-purple-500 rounded-full" style="width: 0%"></div>
      </div>
    </div>
  </div>

<!-- Tables Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
  <!-- Seed Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden w-full">
      <div class="p-4 font-semibold text-green-700 dark:text-green-300">Seed Inventory</div>
      <table class="min-w-full text-sm">
        <thead><tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Quantity</th></tr></thead>
        <tbody id="seed-table-body"><tr><td colspan="2" class="p-4 text-center">Loading...</td></tr></tbody>
      </table>
    </div>

  <!-- Gear Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden w-full">
      <div class="p-4 font-semibold text-blue-700 dark:text-blue-300">Gear Inventory</div>
      <table class="min-w-full text-sm">
        <thead><tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Quantity</th></tr></thead>
        <tbody id="gear-table-body"><tr><td colspan="2" class="p-4 text-center">Loading...</td></tr></tbody>
      </table>
    </div>

  <!-- Egg Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden w-full">
      <div class="p-4 font-semibold text-yellow-700 dark:text-yellow-300">Egg Inventory</div>
      <table class="min-w-full text-sm">
        <thead><tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Quantity</th></tr></thead>
        <tbody id="egg-table-body"><tr><td colspan="2" class="p-4 text-center">Loading...</td></tr></tbody>
      </table>
    </div>

  <!-- Event Table -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden w-full">
      <div class="p-4 font-semibold text-purple-700 dark:text-purple-300">Cosmetics Inventory</div>
      <table class="min-w-full text-sm">
        <thead><tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Quantity</th></tr></thead>
        <tbody id="event-table-body"><tr><td colspan="2" class="p-4 text-center">Loading...</td></tr></tbody>
      </table>
    </div>
  </div

    <footer class="text-center text-gray-600 dark:text-gray-300 text-sm mt-10">
      <p>© 2025 Grow Garden Stock Trackers. All rights reserved.</p>
      <p class="mt-1">Last updated: <span id="last-updated">Never</span></p>
    </footer>
  </div>

  <!-- Scripts -->
<script>
  tailwind.config = {
    darkMode: 'class'
  }
</script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  async function fetchActiveWeather() {
  try {
    const res = await fetch("https://api.joshlei.com/v2/growagarden/weather");
    const data = await res.json();
    const allWeather = data.weather;

    const active = allWeather.find(w => w.active === true);

    const nameEl = document.getElementById("weather-name");
    const iconEl = document.getElementById("weather-img");
    const timerEl = document.getElementById("weather-timer");

    if (active) {
      nameEl.textContent = active.weather_name;
      iconEl.src = active.icon;
      iconEl.alt = active.weather_name;

      function updateRemainingTime() {
        const now = Math.floor(Date.now() / 1000);
        const remaining = active.end_duration_unix - now;
        if (remaining <= 0) {
          nameEl.textContent = "No Weather";
          iconEl.src = "https://uxwing.com/wp-content/themes/uxwing/download/weather/weather-icon.png";
          timerEl.textContent = "No active event";
        } else {
          const minutes = Math.floor(remaining / 60);
          const seconds = remaining % 60;
          timerEl.textContent = `Ends in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      }

      updateRemainingTime();
      setInterval(updateRemainingTime, 1000);
    } else {
      nameEl.textContent = "Normal";
      iconEl.src = "";
      timerEl.textContent = "No active event";
    }

  } catch (err) {
    console.error("❌ Lỗi khi fetch thời tiết:", err);
  }
}
  const durations = {
    seed: 300,       // 5 phút
    gear: 300,       // 5 phút
    egg: 1800,       // 30 phút
    event: 3600      // 1 giờ
  };

  const refreshRates = {
    seed: 300000,
    gear: 300000,
    egg: 1800000,
    event: 3600000
  };

  let lastRestockTime = {
    seed: parseInt(localStorage.getItem('lastRestock_seed')) || 0,
    gear: parseInt(localStorage.getItem('lastRestock_gear')) || 0,
    egg: parseInt(localStorage.getItem('lastRestock_egg')) || 0,
    event: parseInt(localStorage.getItem('lastRestock_event')) || 0,
  };

  function formatTime(ms) {
    const min = Math.floor(ms / 60000);
    const sec = Math.floor((ms % 60000) / 1000);
    return `${min}:${sec.toString().padStart(2, '0')}`;
  }

  function createOrUpdateTimer(type, remaining) {
    let timerEl = document.getElementById(`${type}-timer`);
    if (!timerEl) {
      timerEl = document.createElement('p');
      timerEl.id = `${type}-timer`;
      timerEl.className = "text-sm mt-1";
      document.getElementById(`${type}-card`).appendChild(timerEl);
    }

    const seconds = Math.floor(remaining / 1000);
    timerEl.textContent = `Restock in: ${formatTime(remaining)}`;
    timerEl.className = seconds <= 10
      ? "text-sm mt-1 text-yellow-400 animate-pulse"
      : "text-sm mt-1 text-gray-500";
  }

  function startCountdown() {
    setInterval(() => {
      ['seed', 'gear', 'egg', 'event'].forEach(type => {
        const interval = refreshRates[type];
        const elapsed = Date.now() - lastRestockTime[type];
        const remaining = interval - elapsed;
        createOrUpdateTimer(type, remaining > 0 ? remaining : 0);
      });
    }, 1000);
  }

  let previousSeedStock = localStorage.getItem('lastSeedHash');
  let previousGearStock = localStorage.getItem('lastGearHash');
  let previousEggStock = localStorage.getItem('lastEggHash');
  let previousEventStock = localStorage.getItem('lastEventHash');

  const toggleIcon = document.getElementById('toggle-icon');
  const toggleSwitch = document.querySelector('input[type="checkbox"]');

  const DARK_THEME = 'dark';
  const LIGHT_THEME = 'light';

  function toggleDarkLightMode(mode) {
    toggleIcon.children[0].textContent = mode === DARK_THEME ? 'Dark Mode' : 'Light Mode';
    mode === DARK_THEME
      ? toggleIcon.children[1].classList.replace('fa-sun', 'fa-moon')
      : toggleIcon.children[1].classList.replace('fa-moon', 'fa-sun');
  }

  function switchTheme(event) {
    const isDark = event.target.checked;
    document.documentElement.setAttribute('data-theme', isDark ? DARK_THEME : LIGHT_THEME);
    localStorage.setItem('theme', isDark ? DARK_THEME : LIGHT_THEME);

    if (isDark) {
      document.documentElement.classList.add('dark');
      toggleDarkLightMode(DARK_THEME);
    } else {
      document.documentElement.classList.remove('dark');
      toggleDarkLightMode(LIGHT_THEME);
    }
  }

  // Check Local Storage For Theme
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);
    if (currentTheme === DARK_THEME) {
      document.documentElement.classList.add('dark');
      toggleSwitch.checked = true;
      toggleDarkLightMode(DARK_THEME);
    } else {
      document.documentElement.classList.remove('dark');
      toggleDarkLightMode(LIGHT_THEME);
    }
  }

  toggleSwitch.addEventListener('change', switchTheme);
  async function fetchSeedGear() {
    try {
      const res = await fetch('https://api.joshlei.com/v2/growagarden/stock');
      const data = await res.json();

      const newSeed = JSON.stringify(data.seed_stock);
      const newGear = JSON.stringify(data.gear_stock);

      if (newSeed !== previousSeedStock) {
        updateTable('seed', data.seed_stock);
        previousSeedStock = newSeed;
        localStorage.setItem('lastSeedHash', newSeed);
        lastRestockTime.seed = Date.now();
        localStorage.setItem('lastRestock_seed', lastRestockTime.seed);
      }

      if (newGear !== previousGearStock) {
        updateTable('gear', data.gear_stock);
        previousGearStock = newGear;
        localStorage.setItem('lastGearHash', newGear);
        lastRestockTime.gear = Date.now();
        localStorage.setItem('lastRestock_gear', lastRestockTime.gear);
      }

      document.getElementById('last-updated').textContent = new Date().toLocaleString();
    } catch (e) {
      console.error("❌ Lỗi khi fetch dữ liệu:", e);
    }
  }
  async function fetchEgg() {
    try {
      const res = await fetch('https://api.joshlei.com/v2/growagarden/stock');
      const data = await res.json();

      const newEgg = JSON.stringify(data.egg_stock);

      if (newEgg !== previousEggStock) {
        updateTable('egg', data.egg_stock);
        previousEggStock = newEgg;
        lastRestockTime.egg = Date.now();
        localStorage.setItem('lastRestock_egg', lastRestockTime.egg);
      }

      document.getElementById('last-updated').textContent = new Date().toLocaleString();
    } catch (e) {
      console.error("❌ Lỗi khi fetch dữ liệu:", e);
    }
  }
  async function fetchEvent() {
    try {
      const res = await fetch('https://api.joshlei.com/v2/growagarden/stock');
      const data = await res.json();

      const newEvent = JSON.stringify(data.cosmetic_stock);
      if (newEvent !== previousEventStock) {
        updateTable('event', data.cosmetic_stock);
        previousEventStock = newEvent;
        localStorage.setItem('lastEventHash', newEvent);
        lastRestockTime.event = Date.now();
        localStorage.setItem('lastRestock_event', lastRestockTime.event);
      }

      document.getElementById('last-updated').textContent = new Date().toLocaleString();
    } catch (e) {
      console.error("❌ Lỗi khi fetch dữ liệu:", e);
    }
  }

  function updateTable(type, items) {
    const total = items.reduce((a, b) => a + (b.quantity || 0), 0);
    const countEl = document.getElementById(`${type}-count`);
    const progressEl = document.getElementById(`${type}-progress`);
    if (countEl && progressEl) {
      countEl.textContent = total;
      progressEl.style.width = `${Math.min(100, total / 1000 * 100)}%`;
    }

    const labelMap = {
      seed: 'seed-varieties',
      gear: 'gear-categories',
      egg: 'egg-types',
      event: 'event-upcoming',
    };

    if (labelMap[type]) {
      const labelEl = document.getElementById(labelMap[type]);
      if (labelEl) labelEl.textContent = `Items: ${items.length}`;
    }

    const body = document.getElementById(`${type}-table-body`);
    if (!body) return;

    body.innerHTML = '';
    items.forEach(item => {
      const icon = item.icon ? `<img src="${item.icon}" class="inline w-5 h-5 mr-2 align-middle" alt="">` : "";
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="p-2">${icon}${item.display_name}</td><td class="p-2">${item.quantity}</td>`;
      body.appendChild(tr);
    });
  }

  setInterval(fetchSeedGear, 30 * 1000);
  setInterval(fetchEgg, 30 * 1000);
  setInterval(fetchEvent, 30 * 1000);

  document.addEventListener('DOMContentLoaded', () => {
    fetchSeedGear();
    fetchEgg();
    fetchEvent();
    startCountdown();
  });
</script>
</body>
</html>
